<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Teaching Assistant</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background: #2ecc71;
      color: white;
      padding: 20px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }

    section {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #a5d6a7;
      margin-bottom: 20px;
    }

    h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #2e7d32;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 12px;
      margin-bottom: 5px;
      color: #2e7d32;
    }

    input,
    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #81c784;
      font-size: 1rem;
      background: #ffffff;
      box-sizing: border-box;
    }

    #originalDescription,
    #customDescription {
      min-height: 100px;
      resize: vertical;
    }

    #subtopic {
      max-width: 400px;
    }

    button {
      margin-top: 15px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: #2ecc71;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s ease;
    }

    button:hover {
      background: #27ae60;
    }

    .question-item {
      background: #c8e6c9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #2e7d32;
    }

    video {
      display: block;
      width: 100%;
      border-radius: 12px;
      margin-top: 15px;
    }

    #quizDisplay {
      background: #fffde7;
      border-left: 6px solid #fbc02d;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }

    #quizDisplay p {
      margin: 8px 0;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: center;
    }

    .two-column input {
      height: 45px;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      /* Light gray */
      border-top: 6px solid #4CAF50;
      /* Green */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 700px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>üìó AI Teaching Assistant</h1>
  </header>

  <main>
    <!-- Lesson Info -->
    <section>
      <h2>Lesson Details</h2>
      <label>Subtopic:</label>
      <input type="text" id="subtopic" readonly />
      <!-- <input type="text" id="subtopic" /> -->


      <label>Lesson Description:</label>
      <textarea id="originalDescription" readonly></textarea>
      <!-- <textarea id="originalDescription" ></textarea> -->


      <label>Or Write Your Own:</label>
      <textarea id="customDescription" placeholder="Type your lesson description here..."></textarea>
    </section>

    <!-- Quiz Builder -->
    <section>
      <h2>üìã Quiz Builder</h2>
      <div class="two-column">
        <input type="text" id="questionInput" placeholder="Enter question..." />
        <input type="text" id="answerInput" placeholder="Enter answer..." />
      </div>
      <button type="button" onclick="addQuestion()">‚ûï Add Question</button>

      <div id="questionsList">
        <h3>‚úÖ Added Questions:</h3>
        <div id="addedQuestions"></div>
      </div>
    </section>

    <!-- Video Section -->
    <section>
      <h2>üé• Lesson Video</h2>
      <button type="button" onclick="generateVideo()">Generate Video</button>

      <!-- Video Player -->
      <video id="video" controls></video>

      <!-- ‚úÖ Loading Spinner + Message -->
      <div id="loadingMessage" style="display: none; text-align: center; margin-top: 20px;">
        <div class="spinner"></div>
        <p style="font-size: 1.2rem; color: #555; margin-top: 10px;">Generating your AI video, please wait...</p>
      </div>

      <!-- Subtitle Box -->
      <div id="subtitleBox" style="margin-top:10px; font-size:1.1rem; font-weight:600; color:#2e7d32;"></div>

      <!-- Save Button -->
      <button type="button" onclick="saveToDatabase()">üíæ Save Lesson</button>
    </section>


    <!-- Quiz Display -->
    <section id="quizDisplay">
      <h2>üìù Voice Quiz</h2>
      <p><strong>Question:</strong> <span id="currentQuestionText"></span></p>
      <p><strong>Your Answer:</strong> <span id="spokenAnswerText"></span></p>
      <p><strong>Correct Answer:</strong> <span id="correctAnswerText"></span></p>
    </section>
  </main>

  <!-- ‚úÖ All JS code goes here -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- Read URL Params ---
      const urlParams = new URLSearchParams(window.location.search);
      const returnTo = urlParams.get("returnTo") || "https://genuine-sopapillas-c1e756.netlify.app/";
      // const subtopic = urlParams.get("subtopic") || "";
      // const description = urlParams.get("description") || "";
      const subtopicId = urlParams.get("subtopicId") || "";
      const subtopicName = urlParams.get("subtopic") || "";
      const description = urlParams.get("description") || "";


      console.log("‚úÖ URL Params:", { subtopicId, subtopicName, description }); // DEBUG

      // Fill inputs
      // document.getElementById("subtopic").value = subtopic;
      document.getElementById("subtopic").value = subtopicName;

      document.getElementById("originalDescription").value = decodeURIComponent(description);

      // --- Quiz Handling ---
      const questions = [];

      function addQuestion() {
        const q = document.getElementById("questionInput").value.trim();
        const a = document.getElementById("answerInput").value.trim();
        if (!q || !a) return alert("Please enter both question and answer.");
        questions.push({ question: q, answer: a });
        document.getElementById("questionInput").value = "";
        document.getElementById("answerInput").value = "";
        updateQuestionDisplay();
      }

      function updateQuestionDisplay() {
        const container = document.getElementById("addedQuestions");
        container.innerHTML = "";
        questions.forEach((qa, index) => {
          const div = document.createElement("div");
          div.className = "question-item";
          div.innerHTML = `<strong>Q${index + 1}:</strong> ${qa.question}<br/><strong>A:</strong> ${qa.answer}`;
          container.appendChild(div);
        });
      }

      // // --- Generate Video ---
      // async function generateVideo() {
      //   const descriptionToUse =
      //     document.getElementById("customDescription").value.trim() ||
      //     document.getElementById("originalDescription").value.trim();

      //   const loading = document.getElementById("loadingMessage");
      //   const video = document.getElementById("video");

      //   // Show loading spinner + message, hide video while waiting
      //   loading.style.display = "block";
      //   video.style.display = "none";

      //   try {
      //     const res = await fetch("https://ai-generative-rhk1.onrender.com/generate-and-upload", {
      //       method: "POST",
      //       headers: { "Content-Type": "application/json" },
      //       // body: JSON.stringify({ subtopic, description: descriptionToUse })
      //       body: JSON.stringify({
      //         subtopicId,       // Mongo _id
      //         subtopicName,     // title
      //         description: descriptionToUse
      //       })
      //     });

      //     const data = await res.json();

      //     // Hide loading, show video
      //     loading.style.display = "none";
      //     video.style.display = "block";

      //     video.src = data.firebase_video_url;
      //     video.onended = () => startVoiceQuiz();
      //   } catch (err) {
      //     console.error("‚ùå Error generating video:", err);
      //     loading.innerHTML = `<p style="color:red;">‚ùå Failed to generate video. Try again.</p>`;
      //   }
      // }
      async function generateVideo() {
        const descriptionToUse =
          document.getElementById("customDescription").value.trim() ||
          document.getElementById("originalDescription").value.trim();

        if (!descriptionToUse) {
          alert("‚ùå Please provide a lesson description.");
          return;
        }

        if (!subtopicId || !subtopicName) {
          alert("‚ùå Missing subtopic info. Please return from the admin page.");
          return;
        }

        const loading = document.getElementById("loadingMessage");
        const video = document.getElementById("video");

        loading.style.display = "block";
        video.style.display = "none";

        try {
          const res = await fetch("https://ai-generative-rhk1.onrender.com/generate-and-upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              subtopicId,
              subtopicName,
              description: descriptionToUse
            })
          });

          if (!res.ok) throw new Error(`Server returned ${res.status}`);

          const data = await res.json();
          if (!data.firebase_video_url) throw new Error("No video URL returned");

          loading.style.display = "none";
          video.style.display = "block";
          video.src = data.firebase_video_url;

          video.onended = () => startVoiceQuiz();
        } catch (err) {
          console.error("‚ùå Error generating video:", err);
          loading.innerHTML = `<p style="color:red;">‚ùå Failed to generate video. Try again.</p>`;
        }
      }

      // --- Subtitle Simulation ---
      video.onplay = () => {
        const descriptionToUse =
          document.getElementById("customDescription").value.trim() ||
          document.getElementById("originalDescription").value.trim();

        const lines = descriptionToUse.split(/[.?!]/).filter(x => x.trim());
        let i = 0;
        const subtitleBox = document.getElementById("subtitleBox");

        function showNext() {
          if (i < lines.length && !video.paused && !video.ended) {
            subtitleBox.textContent = lines[i].trim();
            i++;
            setTimeout(showNext, 3000); // change every 3s
          } else if (video.ended) {
            subtitleBox.textContent = ""; // clear after video ends
          }
        }
        showNext();
      };

      function addOrUpdateParam(url, key, value) {
        try {
          const u = new URL(url);
          u.searchParams.set(key, value);
          return u.toString();
        } catch {
          // if returnTo was somehow a relative path, fall back safely
          return url + (url.includes("?") ? "&" : "?") + `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;
        }
      }

      // // --- Save Lesson ---
      // async function saveToDatabase() {
      //   const subtopicToUse = document.getElementById("subtopic").value.trim();
      //   const descriptionToUse =
      //     document.getElementById("customDescription").value.trim() ||
      //     document.getElementById("originalDescription").value.trim();
      //   const videoUrl = document.getElementById("video").src;
      //   if (!videoUrl) return alert("Please generate video first.");

      //   const res = await fetch("https://ai-generative-rhk1.onrender.com/save-full-data", {
      //     method: "POST",
      //     headers: { "Content-Type": "application/json" },
      //     body: JSON.stringify({
      //       subtopic: subtopicToUse,
      //       description: descriptionToUse,
      //       questions,
      //       video_url: videoUrl
      //     })
      //   });

      //   const result = await res.json();

      //   if (result && result.message) {
      //     // Go back to EXACT React page, adding ?saved=true (or &saved=true)
      //     const backUrl = addOrUpdateParam(returnTo, "saved", "true");
      //     window.location.href = backUrl;
      //   } else {
      //     alert("Save failed, please try again!");
      //   }
      // }

      // --- Save Lesson ---
      // async function saveToDatabase() {
      //   const subtopicToUse = document.getElementById("subtopic").value.trim();
      //   const descriptionToUse =
      //     document.getElementById("customDescription").value.trim() ||
      //     document.getElementById("originalDescription").value.trim();
      //   const videoUrl = document.getElementById("video").src;

      //   if (!videoUrl) return alert("Please generate video first.");

      //   try {
      //     // 1Ô∏è‚É£ Save to AI Generator App (keep old behavior)
      //     const res = await fetch("https://ai-generative-rhk1.onrender.com/save-full-data", {
      //       method: "POST",
      //       headers: { "Content-Type": "application/json" },
      //       body: JSON.stringify({
      //         subtopicId: subtopicId,   // ‚úÖ real Mongo _id from React
      //         subtopicName: subtopicToUse, // title
      //         subtopic: subtopicToUse,
      //         description: descriptionToUse,
      //         questions,
      //         video_url: videoUrl
      //       })
      //     });

      //     const result = await res.json();

      //     // 2Ô∏è‚É£ ALSO save video URL to Spring Boot backend (main DB)
      //     // await fetch("https://studentpadmasini.onrender.com/api/content/addVideo", {
      //     //   method: "POST",
      //     //   headers: { "Content-Type": "application/json" },
      //     //   body: JSON.stringify({
      //     //     subtopicId: subtopicToUse, // ‚ö†Ô∏è Must be the MongoDB _id of the subtopic
      //     //     videoUrl: videoUrl
      //     //   })
      //     // });
      //     await fetch("https://studentpadmasini.onrender.com/api/content/addVideo", {
      //       method: "POST",
      //       headers: { "Content-Type": "application/json" },
      //       body: JSON.stringify({
      //         subtopicId: subtopicId,   // ‚úÖ real Mongo _id from React
      //         videoUrl: videoUrl
      //       })
      //     });


      //     // 3Ô∏è‚É£ Redirect back to Admin page like before
      //     if (result && result.message) {
      //       const backUrl = addOrUpdateParam(returnTo, "saved", "true");
      //       window.location.href = backUrl;
      //     } else {
      //       alert("Save failed, please try again!");
      //     }
      //   } catch (err) {
      //     console.error("Error in saveToDatabase:", err);
      //     alert("‚ùå Something went wrong while saving.");
      //   }
      // }


      async function saveToDatabase() {
        const subtopicToUse = document.getElementById("subtopic").value.trim();
        const descriptionToUse =
          document.getElementById("customDescription").value.trim() ||
          document.getElementById("originalDescription").value.trim();
        const videoUrl = document.getElementById("video").src;

        if (!videoUrl) return alert("Please generate video first.");
        if (!subtopicToUse || !descriptionToUse) return alert("Subtopic and description cannot be empty.");

        // Extract subjectName from URL (example: ?subjectName=Physics)
        const urlParams = new URLSearchParams(window.location.search);
        const subjectName = urlParams.get("subjectName") || "General";

        try {
          const payload = {
            subtopicId,          // from URL param
            subtopicName: subtopicToUse,
            description: descriptionToUse,
            questions,
            video_url: videoUrl,
            subjectName
          };

          const res = await fetch("https://ai-generative-rhk1.onrender.com/save-full-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await res.json();

          if (result && result.message) {
            const returnTo = urlParams.get("returnTo") || "https://genuine-sopapillas-c1e756.netlify.app/";
            const backUrl = addOrUpdateParam(returnTo, "saved", "true");
            window.location.href = backUrl;
          } else {
            alert("Save failed, please try again!");
          }

        } catch (err) {
          console.error("Error in saveToDatabase:", err);
          alert("‚ùå Something went wrong while saving.");
        }
      }


      // === Voice Quiz (robust) ===
      const SPEAK_QUESTIONS = true;                  // <-- speaks each question
      const QUESTION_TTS_PAUSE_MS = 800;             // extra gap after TTS before listening

      // listening badge (unchanged)
      const listeningBadge = document.createElement('div');
      listeningBadge.textContent = "üé§ Listening‚Ä¶";
      Object.assign(listeningBadge.style, {
        position: 'fixed',
        right: '16px',
        bottom: '16px',
        padding: '10px 14px',
        background: '#2ecc71',
        color: '#fff',
        borderRadius: '8px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
        fontWeight: '600',
        display: 'none',
        zIndex: 9999
      });
      document.body.appendChild(listeningBadge);
      const showListening = (on) => (listeningBadge.style.display = on ? 'block' : 'none');

      function speak(text) {
        return new Promise((resolve) => {
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = 'en-US';
          utter.onend = () => resolve();
          speechSynthesis.speak(utter);
        });
      }

      function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

      function listen(callback) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { alert("Speech recognition not supported"); callback(""); return; }

        // Abort any previous session
        if (window.activeRecognition) {
          try { window.activeRecognition.abort(); } catch (_) { }
        }

        // stop any TTS still playing
        try { speechSynthesis.cancel(); } catch (_) { }

        const recognition = new SR();
        window.activeRecognition = recognition;
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.continuous = false;

        const videoEl = document.getElementById("video");
        const wasMuted = videoEl.muted;
        videoEl.muted = true;

        showListening(true);
        recognition.start();

        recognition.onresult = (event) => {
          showListening(false);
          videoEl.muted = wasMuted;
          const transcript = event.results[0][0].transcript || "";
          callback(transcript);
        };

        recognition.onerror = () => {
          showListening(false);
          videoEl.muted = wasMuted;
          callback("");
        };

        recognition.onend = () => {
          showListening(false);
          videoEl.muted = wasMuted;
        };
      }

      function normalizeAnswer(s) {
        if (!s) return "";
        return s
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9\s]/g, '')
          .replace(/\b(the|a|an|is|are|was|were|of|to|and|in|on|at|for)\b/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      }

      function levenshtein(a, b) {
        const m = a.length, n = b.length;
        if (m === 0) return n;
        if (n === 0) return m;
        const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
        for (let i = 0; i <= m; i++) dp[i][0] = i;
        for (let j = 0; j <= n; j++) dp[0][j] = j;
        for (let i = 1; i <= m; i++) {
          for (let j = 1; j <= n; j++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            dp[i][j] = Math.min(
              dp[i - 1][j] + 1,
              dp[i][j - 1] + 1,
              dp[i - 1][j - 1] + cost
            );
          }
        }
        return dp[m][n];
      }


      function isAnswerCorrect(studentRaw, correctRaw) {
        if (!studentRaw || !correctRaw) return false;

        // ‚úÖ Split into words
        const correctWords = correctRaw.toLowerCase().trim().split(/\s+/);
        const spokenWords = studentRaw.toLowerCase().trim().split(/\s+/);

        let matchedCount = 0;

        correctWords.forEach(word => {
          if (spokenWords.includes(word)) {
            matchedCount++;
          }
        });

        const matchPercentage = (matchedCount / correctWords.length) * 100;

        console.log("Answer Match %:", matchPercentage);

        // ‚úÖ Require at least 80% words to match
        return matchPercentage >= 80;
      }


      function startVoiceQuiz() {
        if (!questions.length) return;
        let index = 0;
        const quizBox = document.getElementById("quizDisplay");
        quizBox.style.display = "block";

        const qText = document.getElementById("currentQuestionText");
        const aSpoken = document.getElementById("spokenAnswerText");
        const aCorrect = document.getElementById("correctAnswerText");

        async function askQuestion() {
          if (index >= questions.length) {
            await speak("Quiz completed. Well done!");
            quizBox.style.display = "none";
            return;
          }

          const current = questions[index];

          // Show ONLY the question first; hide the answer now
          qText.textContent = current.question;
          aSpoken.textContent = "...waiting...";
          aSpoken.style.color = "#333";
          aCorrect.textContent = "";                 // <-- hide answer until after

          // Optionally speak the question
          if (SPEAK_QUESTIONS) {
            await speak(current.question);
            await delay(QUESTION_TTS_PAUSE_MS);      // gap before listening
          } else {
            await delay(400);
          }

          // Listen for student's answer
          listen(async (spokenAnswer) => {
            const ok = isAnswerCorrect(spokenAnswer, current.answer);

            aSpoken.textContent = spokenAnswer || "(No answer detected)";
            aSpoken.style.color = ok ? "green" : "red";

            // NOW reveal the correct answer (after student answered)
            aCorrect.textContent = current.answer;

            if (ok) {
              await speak("Correct answer, well done!");
            } else {
              await speak(`Wrong answer. The correct answer is ${current.answer}`);
            }

            index++;
            setTimeout(askQuestion, 900);
          });
        }

        askQuestion();
      }

      // expose functions used by inline onclick handlers
      window.addQuestion = addQuestion;
      window.generateVideo = generateVideo;
      window.saveToDatabase = saveToDatabase;
      window.startVoiceQuiz = startVoiceQuiz;

    });
  </script>

</body>

</html>