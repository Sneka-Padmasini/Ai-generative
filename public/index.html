<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Teaching Assistant</title>
<style>
body { font-family: 'Segoe UI', sans-serif; background:#f9fafb; margin:0; padding:0; color:#333; }
header { background:#2ecc71; color:white; padding:20px; text-align:center; }
header h1 { margin:0; font-size:1.8rem; }
main { max-width:900px; margin:20px auto; padding:20px; }
section { background:#e8f5e9; padding:20px; border-radius:12px; border:1px solid #a5d6a7; margin-bottom:20px; }
h2 { margin-top:0; font-size:1.3rem; color:#2e7d32; }
label { font-weight:600; display:block; margin-top:12px; margin-bottom:5px; color:#2e7d32; }
input, textarea, select { width:100%; padding:12px; border-radius:8px; border:1px solid #81c784; font-size:1rem; background:#fff; box-sizing:border-box; }
input[readonly], textarea[readonly] { background:#f1f8f2; cursor:not-allowed; }
#originalDescription, #customDescription { min-height:100px; resize:vertical; }
.two-column { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:10px; }
button { margin-top:15px; padding:10px 16px; border:none; border-radius:6px; background:#2ecc71; color:white; font-weight:bold; cursor:pointer; transition:0.2s ease; }
button:hover { background:#27ae60; }
video { display:block; width:100%; border-radius:12px; margin-top:15px; }
.spinner { border:6px solid #f3f3f3; border-top:6px solid #4CAF50; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.question-item { background:#c8e6c9; padding:10px; border-radius:6px; margin-bottom:10px; border-left:4px solid #2e7d32; }
#quizDisplay { background:#fffde7; border-left:6px solid #fbc02d; padding:15px; border-radius:8px; display:none; }
</style>
</head>
<body>
<header><h1>üìó AI Teaching Assistant</h1></header>
<main>

<!-- Lesson Info -->
<section>
<h2>Lesson Details</h2>
<label>Subject</label>
<select id="subjectSelect">
  <option value="Physics">Physics</option>
  <option value="Chemistry">Chemistry</option>
  <option value="Zoology">Zoology</option>
</select>
<label>Subtopic</label>
<input type="text" id="subtopic" readonly />
<label>Lesson Description</label>
<textarea id="originalDescription" readonly></textarea>
<label>Or Write Your Own</label>
<textarea id="customDescription" placeholder="Type your lesson description here..."></textarea>
</section>

<!-- Quiz Builder -->
<section>
<h2>üìã Quiz Builder</h2>
<div class="two-column">
  <input type="text" id="questionInput" placeholder="Enter question..." />
  <input type="text" id="answerInput" placeholder="Enter answer..." />
</div>
<button type="button" onclick="addQuestion()">‚ûï Add Question</button>
<div id="questionsList"><h3>‚úÖ Added Questions:</h3><div id="addedQuestions"></div></div>
</section>

<!-- Video Section -->
<section>
<h2>üé• Lesson Video</h2>
<button type="button" onclick="generateVideo()">Generate Video</button>
<div id="loadingMessage" style="display:none; text-align:center; margin-top:20px;">
  <div class="spinner"></div>
  <p style="margin-top:10px;">Generating AI video, please wait...</p>
</div>
<video id="video" controls style="display:none;"></video>
</section>

<!-- Save Lesson -->
<section>
<button type="button" onclick="saveToDatabase()">üíæ Save Lesson</button>
</section>

<!-- Voice Quiz -->
<section id="quizDisplay">
<h2>üìù Voice Quiz</h2>
<p><strong>Question:</strong> <span id="currentQuestionText"></span></p>
<p><strong>Your Answer:</strong> <span id="spokenAnswerText"></span></p>
<p><strong>Correct Answer:</strong> <span id="correctAnswerText"></span></p>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const subtopicName = urlParams.get("subtopic") || "";
  const description = urlParams.get("description") || "";
  const subtopicId = urlParams.get("subtopicId") || "";

  document.getElementById("subtopic").value = subtopicName;
  document.getElementById("originalDescription").value = decodeURIComponent(description);

  const video = document.getElementById("video");
  const loading = document.getElementById("loadingMessage");
  const questions = [];

  function addQuestion() {
    const q = document.getElementById("questionInput").value.trim();
    const a = document.getElementById("answerInput").value.trim();
    if (!q || !a) return alert("Please enter both question and answer.");
    questions.push({ question: q, answer: a });
    document.getElementById("questionInput").value = "";
    document.getElementById("answerInput").value = "";
    updateQuestionDisplay();
  }

  function updateQuestionDisplay() {
    const container = document.getElementById("addedQuestions");
    container.innerHTML = "";
    questions.forEach((qa,index)=>{
      const div = document.createElement("div");
      div.className="question-item";
      div.innerHTML=`<strong>Q${index+1}:</strong> ${qa.question}<br/><strong>A:</strong> ${qa.answer}`;
      container.appendChild(div);
    });
  }

  async function generateVideo() {
    const desc = document.getElementById("customDescription").value.trim() || document.getElementById("originalDescription").value.trim();
    if(!desc) return alert("No description provided!");
    loading.style.display="block"; video.style.display="none";
    try {
      const res = await fetch("https://ai-generative-rhk1.onrender.com/generate-and-upload", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({subtopicId, subtopicName, description:desc})
      });
      const data = await res.json();
      if(data.firebase_video_url){
        video.src=data.firebase_video_url;
        video.style.display="block";
        loading.style.display="none";
        video.onended = startVoiceQuiz; // auto start quiz after video
      } else {
        loading.innerHTML="‚ùå Failed to generate video. Check console.";
      }
    } catch(err){ console.error(err); loading.innerHTML="‚ùå Error generating video."; }
  }

  async function saveToDatabase() {
    const subjectName=document.getElementById("subjectSelect").value.trim();
    const desc=document.getElementById("customDescription").value.trim() || document.getElementById("originalDescription").value.trim();
    const subtopicToUse=document.getElementById("subtopic").value.trim();
    const videoUrl=video.src;
    if(!videoUrl) return alert("Please generate video first!");
    try {
      const res=await fetch("https://ai-generative-rhk1.onrender.com/save-full-data",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          subtopicId,
          subtopicName:subtopicToUse,
          description:desc,
          video_url:videoUrl,
          questions,
          subjectName
        })
      });
      const result=await res.json();
      if(result.message) alert("‚úÖ Lesson saved successfully!");
      else alert("‚ùå Failed to save lesson.");
    } catch(err){ console.error(err); alert("‚ùå Something went wrong while saving."); }
  }

  // --- Voice Quiz ---
  function startVoiceQuiz() {
    if(!questions.length) return;
    let index=0;
    const quizBox=document.getElementById("quizDisplay");
    quizBox.style.display="block";
    const qText=document.getElementById("currentQuestionText");
    const aSpoken=document.getElementById("spokenAnswerText");
    const aCorrect=document.getElementById("correctAnswerText");

    async function askQuestion() {
      if(index>=questions.length){ quizBox.style.display="none"; return; }
      const current=questions[index];
      qText.textContent=current.question;
      aSpoken.textContent="...waiting...";
      aSpoken.style.color="#333";
      aCorrect.textContent="";
      await speak(current.question);
      await delay(800);
      listen(async (spokenAnswer)=>{
        const ok=isAnswerCorrect(spokenAnswer,current.answer);
        aSpoken.textContent=spokenAnswer||"(No answer)";
        aSpoken.style.color=ok?"green":"red";
        aCorrect.textContent=current.answer;
        if(ok) await speak("Correct answer, well done!");
        else await speak(`Wrong answer. Correct: ${current.answer}`);
        index++; setTimeout(askQuestion,900);
      });
    }
    askQuestion();
  }

  function speak(text){ return new Promise(resolve=>{ const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; u.onend=()=>resolve(); speechSynthesis.speak(u); }); }
  function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function listen(callback){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){ alert("Speech recognition not supported"); callback(""); return; }
    if(window.activeRecognition) try{ window.activeRecognition.abort(); }catch{}
    const recognition=new SR(); window.activeRecognition=recognition;
    recognition.lang="en-US"; recognition.interimResults=false; recognition.maxAlternatives=1; recognition.continuous=false;
    const videoEl=video; const wasMuted=videoEl.muted; videoEl.muted=true;
    recognition.start();
    recognition.onresult=(event)=>{ videoEl.muted=wasMuted; callback(event.results[0][0].transcript||""); };
    recognition.onerror=()=>{ videoEl.muted=wasMuted; callback(""); };
    recognition.onend=()=>{ videoEl.muted=wasMuted; };
  }

  function normalizeAnswer(s){ if(!s)return""; return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s]/g,'').replace(/\b(the|a|an|is|are|was|were|of|to|and|in|on|at|for)\b/g,' ').replace(/\s+/g,' ').trim(); }
  function isAnswerCorrect(studentRaw, correctRaw){
    if(!studentRaw || !correctRaw) return false;
    const correctWords=correctRaw.toLowerCase().trim().split(/\s+/);
    const spokenWords=studentRaw.toLowerCase().trim().split(/\s+/);
    let matchedCount=0;
    correctWords.forEach(w=>{ if(spokenWords.includes(w)) matchedCount++; });
    return (matchedCount/correctWords.length)*100>=80;
  }

  window.addQuestion=addQuestion;
  window.generateVideo=generateVideo;
  window.saveToDatabase=saveToDatabase;
  window.startVoiceQuiz=startVoiceQuiz;

});
</script>
</body>
</html>
