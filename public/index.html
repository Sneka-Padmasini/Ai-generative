<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Teaching Assistant</title>
<style>
  /* --- keep your original CSS here --- */
  body { font-family: 'Segoe UI', sans-serif; background:#f9fafb; margin:0; padding:0; color:#333; }
  header { background:#2ecc71; color:white; padding:20px; text-align:center; }
  header h1 { margin:0; font-size:1.8rem; }
  main { max-width:900px; margin:20px auto; padding:20px; }
  section { background:#e8f5e9; padding:20px; border-radius:12px; border:1px solid #a5d6a7; margin-bottom:20px; }
  h2 { margin-top:0; font-size:1.3rem; color:#2e7d32; }
  label { font-weight:600; display:block; margin-top:12px; margin-bottom:5px; color:#2e7d32; }
  input, textarea { width:100%; padding:12px; border-radius:8px; border:1px solid #81c784; font-size:1rem; background:#fff; box-sizing:border-box; }
  #originalDescription,#customDescription { min-height:100px; resize:vertical; }
  #subtopic { max-width:400px; }
  button { margin-top:15px; padding:10px 16px; border:none; border-radius:6px; background:#2ecc71; color:white; font-weight:bold; cursor:pointer; transition:0.2s ease; }
  button:hover { background:#27ae60; }
  .question-item { background:#c8e6c9; padding:10px; border-radius:6px; margin-bottom:10px; border-left:4px solid #2e7d32; }
  video { display:block; width:100%; border-radius:12px; margin-top:15px; }
  .two-column { display:grid; grid-template-columns:1fr 1fr; gap:20px; align-items:center; }
  .two-column input { height:45px; }
  .spinner { border:6px solid #f3f3f3; border-top:6px solid #4CAF50; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto; }
  @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
  @media (max-width:700px){ .two-column{grid-template-columns:1fr;} }
</style>
</head>
<body>
<header>
  <h1>üìó AI Teaching Assistant</h1>
</header>
<main>
  <section>
    <h2>Lesson Details</h2>
    <label>Subtopic:</label>
    <input type="text" id="subtopic" readonly />
    <label>Lesson Description:</label>
    <textarea id="originalDescription" readonly></textarea>
    <label>Or Write Your Own:</label>
    <textarea id="customDescription" placeholder="Type your lesson description here..."></textarea>
  </section>

  <section>
    <h2>üé• Lesson Video</h2>
    <button type="button" onclick="generateVideo()">Generate Video</button>
    <video id="video" controls></video>
    <div id="loadingMessage" style="display:none; text-align:center; margin-top:20px;">
      <div class="spinner"></div>
      <p style="font-size:1.2rem; color:#555; margin-top:10px;">Generating your AI video, please wait...</p>
    </div>
    <div id="subtitleBox" style="margin-top:10px; font-size:1.1rem; font-weight:600; color:#2e7d32;"></div>
    <button type="button" onclick="saveToDatabase()">üíæ Save Lesson</button>
  </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const returnTo = urlParams.get("returnTo") || "/";
  const subtopic = urlParams.get("subtopic") || "";
  const description = urlParams.get("description") || "";
  const subject = urlParams.get("subject") || "";

  document.getElementById("subtopic").value = subtopic;
  document.getElementById("originalDescription").value = decodeURIComponent(description);

  const video = document.getElementById("video");
  const loading = document.getElementById("loadingMessage");
  const subtitleBox = document.getElementById("subtitleBox");

  async function generateVideo() {
    const descriptionToUse = document.getElementById("customDescription").value.trim() || document.getElementById("originalDescription").value.trim();
    loading.style.display = "block";
    video.style.display = "none";

    try {
      // ---- MOCK VIDEO GENERATION ----
      // replace this with your actual AI generation service
      await new Promise(res => setTimeout(res, 3000));
      const mockVideoURL = "https://www.w3schools.com/html/mov_bbb.mp4";

      video.src = mockVideoURL;
      video.style.display = "block";
      loading.style.display = "none";

      // Simple subtitle simulation
      const lines = descriptionToUse.split(/[.?!]/).filter(x => x.trim());
      let i = 0;
      video.onplay = function() {
        function showNext() {
          if (i < lines.length && !video.paused && !video.ended) {
            subtitleBox.textContent = lines[i].trim();
            i++;
            setTimeout(showNext, 3000);
          } else if(video.ended){ subtitleBox.textContent=""; }
        }
        showNext();
      };
    } catch(err){
      console.error(err);
      loading.innerHTML = `<p style="color:red;">‚ùå Failed to generate video</p>`;
    }
  }

  async function saveToDatabase() {
    const subtopicToUse = document.getElementById("subtopic").value.trim();
    const descriptionToUse = document.getElementById("customDescription").value.trim() || document.getElementById("originalDescription").value.trim();
    const videoUrl = video.src;

    if (!videoUrl) return alert("Please generate video first.");
    if (!subject) return alert("Missing subject in URL!");

    try {
      const res = await fetch("https://ai-generative-rhk1.onrender.com/save-ai-video", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          subject,
          subtopic: subtopicToUse,
          description: descriptionToUse,
          questions: [], 
          video_url: videoUrl
        })
      });
      const data = await res.json();
      if(data.success){
        alert(`‚úÖ Saved to ${subject} collection successfully!`);
        window.location.href = returnTo;
      } else {
        alert("‚ùå Save failed!");
      }
    } catch(err){
      console.error(err);
      alert("‚ùå Something went wrong!");
    }
  }

  window.generateVideo = generateVideo;
  window.saveToDatabase = saveToDatabase;
});
</script>
</body>
</html>
